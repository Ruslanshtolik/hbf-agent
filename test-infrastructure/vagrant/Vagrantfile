# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Base box
  config.vm.box = "ubuntu/jammy64"
  
  # Common provisioning
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y iptables curl wget git make
  SHELL

  # Management Network Nodes
  
  # Consul Server
  config.vm.define "consul" do |consul|
    consul.vm.hostname = "consul"
    consul.vm.network "private_network", ip: "10.0.0.10"
    consul.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 2
    end
    consul.vm.provision "shell", inline: <<-SHELL
      wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
      apt-get update && apt-get install -y consul
      
      cat > /etc/consul.d/consul.hcl <<EOF
datacenter = "dc1"
data_dir = "/opt/consul"
server = true
bootstrap_expect = 1
ui_config {
  enabled = true
}
client_addr = "0.0.0.0"
bind_addr = "10.0.0.10"
EOF
      
      systemctl enable consul
      systemctl start consul
    SHELL
  end

  # Prometheus Server
  config.vm.define "prometheus" do |prometheus|
    prometheus.vm.hostname = "prometheus"
    prometheus.vm.network "private_network", ip: "10.0.0.11"
    prometheus.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 2
    end
    prometheus.vm.provision "shell", inline: <<-SHELL
      wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
      tar xvfz prometheus-*.tar.gz
      cd prometheus-*
      cp prometheus promtool /usr/local/bin/
      mkdir -p /etc/prometheus /var/lib/prometheus
      cp -r consoles console_libraries /etc/prometheus/
      
      cat > /etc/prometheus/prometheus.yml <<EOF
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'hbf-agents'
    static_configs:
      - targets:
        - '10.1.0.101:9091'
        - '10.1.0.102:9091'
        - '10.1.0.103:9091'
        - '10.2.0.201:9091'
        - '10.2.0.202:9091'
        - '10.2.0.203:9091'
  
  - job_name: 'consul'
    static_configs:
      - targets: ['10.0.0.10:8500']
EOF
      
      cat > /etc/systemd/system/prometheus.service <<EOF
[Unit]
Description=Prometheus
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
      
      systemctl daemon-reload
      systemctl enable prometheus
      systemctl start prometheus
    SHELL
  end

  # Grafana Server
  config.vm.define "grafana" do |grafana|
    grafana.vm.hostname = "grafana"
    grafana.vm.network "private_network", ip: "10.0.0.12"
    grafana.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 1
    end
    grafana.vm.provision "shell", inline: <<-SHELL
      apt-get install -y software-properties-common
      add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
      wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
      apt-get update
      apt-get install -y grafana
      
      systemctl enable grafana-server
      systemctl start grafana-server
    SHELL
  end

  # Application Network Nodes
  
  (1..3).each do |i|
    config.vm.define "hbf-node-#{i}" do |node|
      node.vm.hostname = "hbf-node-#{i}"
      node.vm.network "private_network", ip: "10.0.0.#{100+i}"
      node.vm.network "private_network", ip: "10.1.0.#{100+i}"
      node.vm.provider "virtualbox" do |vb|
        vb.memory = "4096"
        vb.cpus = 2
      end
      node.vm.provision "shell", inline: <<-SHELL
        # Install Go
        wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
        tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
        echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile
        
        # Clone and build HBF agent
        cd /opt
        git clone /vagrant/../../ hbf-agent || true
        cd hbf-agent
        /usr/local/go/bin/go build -o /usr/local/bin/hbf-agent ./cmd/hbf-agent
        
        # Create config
        mkdir -p /etc/hbf-agent
        cat > /etc/hbf-agent/config.yaml <<EOF
agent:
  node_id: "hbf-node-#{i}"
  datacenter: "dc1"
  bind_addr: "10.1.0.#{100+i}"
  api_port: 9090

firewall:
  backend: "iptables"
  default_policy: "deny"
  enable_ipv6: false
  sync_interval: "30s"
  rules:
    - chain: "INPUT"
      protocol: "tcp"
      dport: "22"
      action: "ACCEPT"
      comment: "Allow SSH"
    - chain: "INPUT"
      protocol: "tcp"
      dport: "8080"
      action: "ACCEPT"
      comment: "Allow web service"

service_mesh:
  enabled: true
  bind_address: "0.0.0.0"
  proxy_port: 8080
  admin_port: 8081
  discovery:
    backend: "consul"
    address: "10.0.0.10:8500"
    timeout: "5s"
    interval: "10s"

monitoring:
  enabled: true
  metrics_port: 9091
  metrics_path: "/metrics"

log:
  level: "info"
  format: "text"
EOF
        
        # Install systemd service
        cp /opt/hbf-agent/deploy/systemd/hbf-agent.service /etc/systemd/system/
        systemctl daemon-reload
        systemctl enable hbf-agent
        systemctl start hbf-agent
      SHELL
    end
  end

  # Database Network Nodes
  
  (1..3).each do |i|
    config.vm.define "db-node-#{i}" do |node|
      node.vm.hostname = "db-node-#{i}"
      node.vm.network "private_network", ip: "10.0.0.#{200+i}"
      node.vm.network "private_network", ip: "10.2.0.#{200+i}"
      node.vm.provider "virtualbox" do |vb|
        vb.memory = "8192"
        vb.cpus = 4
      end
      node.vm.provision "shell", inline: <<-SHELL
        # Install PostgreSQL
        apt-get install -y postgresql postgresql-contrib
        
        # Configure PostgreSQL
        sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/" /etc/postgresql/*/main/postgresql.conf
        echo "host all all 10.0.0.0/8 md5" >> /etc/postgresql/*/main/pg_hba.conf
        systemctl restart postgresql
        
        # Install Go and HBF agent (same as application nodes)
        wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
        tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
        echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile
        
        cd /opt
        git clone /vagrant/../../ hbf-agent || true
        cd hbf-agent
        /usr/local/go/bin/go build -o /usr/local/bin/hbf-agent ./cmd/hbf-agent
        
        mkdir -p /etc/hbf-agent
        cat > /etc/hbf-agent/config.yaml <<EOF
agent:
  node_id: "db-node-#{i}"
  datacenter: "dc1"
  bind_addr: "10.2.0.#{200+i}"
  api_port: 9090

firewall:
  backend: "iptables"
  default_policy: "deny"
  enable_ipv6: false
  rules:
    - chain: "INPUT"
      protocol: "tcp"
      dport: "22"
      action: "ACCEPT"
    - chain: "INPUT"
      protocol: "tcp"
      dport: "5432"
      source: "10.1.0.0/24"
      action: "ACCEPT"
      comment: "Allow PostgreSQL from app network"

service_mesh:
  enabled: true
  discovery:
    backend: "consul"
    address: "10.0.0.10:8500"

monitoring:
  enabled: true
  metrics_port: 9091
EOF
        
        cp /opt/hbf-agent/deploy/systemd/hbf-agent.service /etc/systemd/system/
        systemctl daemon-reload
        systemctl enable hbf-agent
        systemctl start hbf-agent
      SHELL
    end
  end

  # Load Balancer
  config.vm.define "haproxy" do |lb|
    lb.vm.hostname = "haproxy"
    lb.vm.network "private_network", ip: "10.3.0.100"
    lb.vm.network "private_network", ip: "10.1.0.100"
    lb.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end
    lb.vm.provision "shell", inline: <<-SHELL
      apt-get install -y haproxy
      
      cat > /etc/haproxy/haproxy.cfg <<EOF
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http_front
    bind *:80
    stats uri /haproxy?stats
    default_backend http_back

backend http_back
    balance roundrobin
    server hbf-node-1 10.1.0.101:8080 check
    server hbf-node-2 10.1.0.102:8080 check
    server hbf-node-3 10.1.0.103:8080 check
EOF
      
      systemctl restart haproxy
    SHELL
  end
end
